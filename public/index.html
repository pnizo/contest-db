<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン - コンテストDB</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <header class="login-header">
                <h1>ログイン</h1>
                <p>コンテスト成績データベース</p>
            </header>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="email">メールアドレス</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="password">パスワード</label>
                    <input type="password" id="password" name="password" required>
                </div>

                <button type="submit" class="login-btn">ログイン</button>
            </form>
        </div>

        <div id="notification" class="notification hidden"></div>
    </div>

    <script>
        // JWT管理ユーティリティ
        const AuthToken = {
            get() {
                return localStorage.getItem('authToken');
            },
            set(token) {
                localStorage.setItem('authToken', token);
            },
            remove() {
                localStorage.removeItem('authToken');
            },
            getHeaders() {
                const token = this.get();
                return token ? { 'Authorization': `Bearer ${token}` } : {};
            }
        };

        class LoginManager {
            constructor() {
                this.init();
            }

            init() {
                this.checkAuthStatus();
                this.bindEvents();
            }

            async checkAuthStatus() {
                try {
                    console.log('Checking auth status on login page...');
                    const token = AuthToken.get();
                    console.log('Token exists in localStorage:', !!token);
                    
                    const response = await fetch('/api/auth/status', {
                        headers: {
                            ...AuthToken.getHeaders(),
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    const result = await response.json();
                    
                    console.log('Auth status result:', result);
                    
                    if (result.isAuthenticated) {
                        console.log('User is authenticated, redirecting to /registrations');
                        window.location.href = '/registrations';
                    } else {
                        console.log('User is not authenticated, staying on login page');
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                }
            }

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin(e);
                });
            }

            async handleLogin(e) {
                const formData = new FormData(e.target);
                const loginData = Object.fromEntries(formData.entries());
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;

                // ボタンを無効化
                submitBtn.disabled = true;
                submitBtn.textContent = 'ログイン中...';

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(loginData),
                        credentials: 'include'
                    });

                    const result = await response.json();
                    console.log('Login response:', result);

                    if (result.success) {
                        // JWTトークンを保存
                        if (result.token) {
                            AuthToken.set(result.token);
                            console.log('JWT token saved:', result.token.substring(0, 20) + '...');
                            console.log('Verifying token storage...');
                            const storedToken = AuthToken.get();
                            console.log('Token retrieved from storage:', storedToken ? storedToken.substring(0, 20) + '...' : 'null');
                        } else {
                            console.log('No token received in login response');
                            console.log('Full response object:', result);
                        }
                        this.showNotification('ログインしました', 'success');
                        submitBtn.textContent = 'リダイレクト中...';
                        setTimeout(() => {
                            console.log('Redirecting to /registrations after login...');
                            console.log('Final token check before redirect:', AuthToken.get() ? 'exists' : 'missing');
                            window.location.href = '/registrations';
                        }, 1000);
                    } else {
                        this.showNotification(result.error, 'error');
                        // ボタンを再有効化
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                } catch (error) {
                    this.showNotification('ログインエラーが発生しました: ' + error.message, 'error');
                    // ボタンを再有効化
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);

                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.classList.add('hidden');
                    }, 300);
                }, 3000);
            }
        }

        const loginManager = new LoginManager();
    </script>
</body>
</html>