<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン - コンテストDB</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <header class="login-header">
                <h1>ログイン</h1>
                <p>コンテスト成績データベース</p>
            </header>

            <div class="login-form">
                <!-- Google SSO セクション -->
                <div class="google-sso-section">
                    <div id="googleBtnContainer"></div>
                    <div id="googleError" class="google-error hidden"></div>
                </div>

                <!-- 区切り線 -->
                <div class="login-divider">
                    <span>ゲストアカウント</span>
                </div>

                <!-- ゲストログインフォーム -->
                <form id="loginForm" class="guest-login-form">
                    <div class="form-group">
                        <label for="email">メールアドレス</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="password">パスワード</label>
                        <input type="password" id="password" name="password" required>
                    </div>

                    <button type="submit" class="guest-login-btn">ゲストログイン</button>
                </form>
            </div>
        </div>

        <div id="notification" class="notification hidden"></div>
    </div>

    <script>
        // JWT管理ユーティリティ
        const AuthToken = {
            get() {
                return localStorage.getItem('authToken');
            },
            set(token) {
                localStorage.setItem('authToken', token);
            },
            remove() {
                localStorage.removeItem('authToken');
            },
            getHeaders() {
                const token = this.get();
                return token ? { 'Authorization': `Bearer ${token}` } : {};
            }
        };

        class LoginManager {
            constructor() {
                this.googleClientId = null;
                this.init();
            }

            // チェックイン専用ドメインかどうか
            isCheckinDomain() {
                const host = window.location.hostname;
                return host === 'ticket-checkin.fwj.jp' || host.startsWith('ticket-checkin.');
            }

            // チェックイン専用ドメインかどうかでリダイレクト先を決定
            getRedirectUrl() {
                if (this.isCheckinDomain()) {
                    return '/checkin';
                }
                return '/registrations';
            }

            async init() {
                await this.checkAuthStatus();
                this.bindEvents();
                await this.initGoogleSSO();
            }

            async checkAuthStatus() {
                try {
                    console.log('Checking auth status on login page...');
                    const token = AuthToken.get();
                    console.log('Token exists in localStorage:', !!token);

                    const response = await fetch('/api/auth/status', {
                        headers: {
                            ...AuthToken.getHeaders(),
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    const result = await response.json();

                    console.log('Auth status result:', result);

                    if (result.isAuthenticated) {
                        if (this.isCheckinDomain()) {
                            console.log('User is authenticated on checkin domain, staying on login page');
                        } else {
                            const redirectTo = this.getRedirectUrl();
                            console.log('User is authenticated, redirecting to ' + redirectTo);
                            window.location.href = redirectTo;
                        }
                    } else {
                        console.log('User is not authenticated, staying on login page');
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                }
            }

            async initGoogleSSO() {
                try {
                    // サーバーからGoogle Client IDを取得
                    const response = await fetch('/api/auth/config');
                    const config = await response.json();
                    this.googleClientId = config.googleClientId;

                    if (!this.googleClientId) {
                        console.log('Google Client ID not configured, hiding SSO section');
                        document.querySelector('.google-sso-section').innerHTML =
                            '<p class="google-not-configured">Google SSOは設定されていません</p>';
                        return;
                    }

                    // Google Identity Services SDKを読み込み
                    const script = document.createElement('script');
                    script.src = 'https://accounts.google.com/gsi/client';
                    script.async = true;
                    script.defer = true;
                    script.onload = () => this.renderGoogleButton();
                    document.head.appendChild(script);
                } catch (error) {
                    console.error('Failed to init Google SSO:', error);
                }
            }

            renderGoogleButton() {
                if (!window.google || !this.googleClientId) return;

                google.accounts.id.initialize({
                    client_id: this.googleClientId,
                    callback: (response) => this.handleGoogleCallback(response),
                });

                google.accounts.id.renderButton(
                    document.getElementById('googleBtnContainer'),
                    {
                        theme: 'outline',
                        size: 'large',
                        width: '100%',
                        text: 'signin_with',
                        locale: 'ja',
                    }
                );
            }

            async handleGoogleCallback(response) {
                const errorEl = document.getElementById('googleError');
                errorEl.classList.add('hidden');

                try {
                    const res = await fetch('/api/auth/google', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ credential: response.credential }),
                        credentials: 'include'
                    });

                    const result = await res.json();

                    if (result.success) {
                        if (result.token) {
                            AuthToken.set(result.token);
                        }
                        this.showNotification('ログインしました', 'success');
                        const redirectTo = this.getRedirectUrl();
                        setTimeout(() => {
                            window.location.href = redirectTo;
                        }, 1000);
                    } else {
                        errorEl.textContent = result.error;
                        errorEl.classList.remove('hidden');
                    }
                } catch (error) {
                    errorEl.textContent = 'Google認証エラーが発生しました';
                    errorEl.classList.remove('hidden');
                }
            }

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin(e);
                });
            }

            async handleLogin(e) {
                const formData = new FormData(e.target);
                const loginData = Object.fromEntries(formData.entries());
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;

                submitBtn.disabled = true;
                submitBtn.textContent = 'ログイン中...';

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(loginData),
                        credentials: 'include'
                    });

                    const result = await response.json();
                    console.log('Login response:', result);

                    if (result.success) {
                        if (result.token) {
                            AuthToken.set(result.token);
                        }
                        this.showNotification('ログインしました', 'success');
                        submitBtn.textContent = 'リダイレクト中...';
                        const redirectTo = this.getRedirectUrl();
                        setTimeout(() => {
                            window.location.href = redirectTo;
                        }, 1000);
                    } else {
                        this.showNotification(result.error, 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                } catch (error) {
                    this.showNotification('ログインエラーが発生しました: ' + error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.remove('hidden');

                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);

                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.classList.add('hidden');
                    }, 300);
                }, 3000);
            }
        }

        const loginManager = new LoginManager();
    </script>
</body>
</html>
